# =============================================================================
# AI Advisor OSC - Docker Compose (단일 테넌트, 완전 격리)
# =============================================================================
#
# 사용법:
#   1. .env 파일 생성 (docker-compose.yml과 같은 디렉토리):
#      POSTGRES_PASSWORD=your_secure_password_here
#      SERVER_HOST=your.server.ip.or.domain
#
#   2. 시작:    docker compose up -d
#      중지:    docker compose down
#      로그:    docker compose logs -f
#      재빌드:  docker compose up -d --build
#
# 포트 정보 (OSC 전용 - 완전 격리):
#   - Frontend:   10310
#   - Backend:    10311
#   - PostgreSQL: 10312 (localhost only)
#   - Redis:      10313 (localhost only)
#   - Qdrant:     10314 (localhost only)
#
# 접속 방법:
#   - Frontend: http://${SERVER_HOST}:10310
#   - Admin:    http://${SERVER_HOST}:10310/admin-login
#   - API Docs: http://${SERVER_HOST}:10311/docs
#
# =============================================================================

services:
  # ==========================================================================
  # Frontend (React + Nginx)
  # ==========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - REACT_APP_API_URL=http://${SERVER_HOST:-localhost}:10311
    container_name: advisor-osc-frontend
    restart: unless-stopped
    ports:
      - "10310:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - advisor-osc-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # Backend API Server (GPU 지원)
  # ==========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: advisor-osc-backend
    restart: unless-stopped
    runtime: nvidia
    ports:
      - "10311:8000"
    env_file:
      - ./backend/.env.docker
    environment:
      - DATABASE_URL=postgresql+asyncpg://advisor:${POSTGRES_PASSWORD:-change_me_in_production}@postgres:5432/advisor_osc_db
      - REDIS_URL=redis://redis:6379/0
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8000
      - DATA_BASE_PATH=/app/data
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - ./backend/uploads:/app/uploads
      - ./backend/data:/app/data
      - ./backend/eval:/app/eval
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_started
    networks:
      - advisor-osc-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==========================================================================
  # PostgreSQL (OSC 전용 - 완전 격리)
  # ==========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: advisor-osc-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: advisor
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me_in_production}
      POSTGRES_DB: advisor_osc_db
    volumes:
      - advisor-osc-postgres-data:/var/lib/postgresql/data
    networks:
      - advisor-osc-network
    ports:
      - "127.0.0.1:10312:5432"  # localhost only (보안: 외부 접근 차단)
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U advisor -d advisor_osc_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # ==========================================================================
  # Redis (OSC 전용 - 완전 격리)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: advisor-osc-redis
    restart: unless-stopped
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru --appendonly yes
    volumes:
      - advisor-osc-redis-data:/data
    networks:
      - advisor-osc-network
    ports:
      - "127.0.0.1:10313:6379"  # localhost only (보안: 외부 접근 차단)
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  # ==========================================================================
  # Qdrant Vector DB (OSC 전용 - 완전 격리)
  # ==========================================================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: advisor-osc-qdrant
    restart: unless-stopped
    volumes:
      - advisor-osc-qdrant-data:/qdrant/storage
    networks:
      - advisor-osc-network
    ports:
      - "127.0.0.1:10314:6333"  # localhost only (보안: 외부 접근 차단)
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

# =============================================================================
# Networks (OSC 전용 격리 네트워크)
# =============================================================================
networks:
  advisor-osc-network:
    name: advisor-osc-network
    driver: bridge

# =============================================================================
# Volumes (OSC 전용 영구 저장소)
# =============================================================================
volumes:
  advisor-osc-postgres-data:
    name: advisor-osc-postgres-data
  advisor-osc-redis-data:
    name: advisor-osc-redis-data
  advisor-osc-qdrant-data:
    name: advisor-osc-qdrant-data
