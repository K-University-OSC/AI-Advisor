# Advisor OSC Finance RAG 버전별 비교

## 테스트 환경
- **테스트 데이터셋**: Allganize Finance (60 cases)
- **평가 방식**: LLM-as-Judge (Gemini 3 Flash)
- **테스트 일자**: 2026-02-01

---

## 버전별 성능 요약

| 버전 | 파서 | 전체 정확도 | paragraph | image | table |
|------|------|------------|-----------|-------|-------|
| **baseline_v1** | Azure Document Intelligence | **98.3%** (59/60) | 100% (30/30) | 100% (20/20) | 90% (9/10) |
| **v1.2** | Gemini 3 Flash OCR | **80.0%** (48/60) | 80% (24/30) | 85% (17/20) | 70% (7/10) |
| **v1.1** | PyMuPDF (무료) | **31.7%** (19/60) | 40% (12/30) | 30% (6/20) | 10% (1/10) |

---

## baseline_v1: Azure Document Intelligence

### RAG 파이프라인
```
┌─────────────────────────────────────────────────────────────┐
│  Document Parser: Azure Document Intelligence               │
│  - 레이아웃 분석: Layout Model                              │
│  - 테이블 구조화: 자동                                       │
│  - OCR: 내장 고정밀 OCR                                      │
│  - 비용: $1.50/1000 pages (Read), $10/1000 pages (Layout)   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Image Captioning: GPT-4o                                   │
│  - 차트/그래프 설명 생성                                     │
│  - 이미지 내 텍스트 추출                                     │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Chunking: Hierarchical Chunker                             │
│  - Parent Chunk: 2000 tokens                                │
│  - Child Chunk: 500 tokens                                  │
│  - Overlap: 50 tokens                                       │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Embedding: text-embedding-3-large (OpenAI)                 │
│  - Dense: 3072 dimensions                                   │
│  - Sparse: BM25 (optional)                                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Vector Store: Qdrant                                       │
│  - Collection: ad_rag_baseline_v1_finance                   │
│  - Search: Dense (Cosine Similarity)                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Retrieval: HierarchicalRetriever                           │
│  - top_k: 15                                                │
│  - rerank_top_k: 50                                         │
│  - rerank: Cohere Reranker v3                               │
│  - expand_to_parent: true                                   │
│  - use_hybrid: false (Dense only)                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Answer Generation: Gemini 3 Flash                          │
│  - Fallback: GPT-5-mini                                     │
│  - Temperature: 0.0                                         │
└─────────────────────────────────────────────────────────────┘
```

### 테스트 결과
- **정확도**: 98.3% (59/60)
- **결과 파일**: `finance_baseline_v1_azure_20260130.json`

---

## v1.2: Gemini 3 Flash OCR

### RAG 파이프라인
```
┌─────────────────────────────────────────────────────────────┐
│  Document Parser: Gemini 3 Flash OCR                        │
│  - 레이아웃 분석: Gemini Vision                             │
│  - 테이블 구조화: Markdown 변환                             │
│  - OCR: Gemini 내장 OCR (OCR Arena 1위)                     │
│  - 비용: ~$0.01/page ($0.50/1M input tokens)                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Image Captioning: GPT-4o                                   │
│  - 차트/그래프 설명 생성                                     │
│  - 243개 이미지 캡셔닝 수행                                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Chunking: Hierarchical Chunker                             │
│  - Parent Chunk: 2000 tokens                                │
│  - Child Chunk: 500 tokens                                  │
│  - Overlap: 50 tokens                                       │
│  - 총 청크: 582 (parent) / 5,602 (child)                    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Embedding: text-embedding-3-large (OpenAI)                 │
│  - Dense: 3072 dimensions                                   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Vector Store: Qdrant                                       │
│  - Collection: advisor_osc_finance_gemini                   │
│  - 총 요소: 2,962개                                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Retrieval: HierarchicalRetriever                           │
│  - top_k: 15                                                │
│  - rerank_top_k: 50                                         │
│  - rerank: Cohere Reranker (Trial - rate limited)           │
│  - expand_to_parent: true                                   │
│  - use_hybrid: false                                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Answer Generation: Gemini 3 Flash                          │
│  - Fallback: GPT-5-mini (10건 사용)                         │
│  - Temperature: 0.0                                         │
└─────────────────────────────────────────────────────────────┘
```

### 테스트 결과
- **정확도**: 80.0% (48/60)
- **Fallback 사용**: 10건
- **결과 파일**: `finance_v1.2_gemini_20260201.json`

### 실패 케이스 분석 (12건)
| idx | context_type | 실패 원인 |
|-----|--------------|-----------|
| 7 | image | 성과 순위 vs 선호도 순위 구분 실패 |
| 11 | image | 투자 매력도 공통점 누락 |
| 13 | paragraph | 출시 배경 설명 불일치 |
| 15 | paragraph | 구체적 수치 누락 (40년 납부 66,000엔) |
| 17 | table | 법률명 일부 누락 |
| 18 | table | 2005년 제정 법률 정보 누락 |
| 19 | table | 제정일 정보 검색 실패 |
| 32 | paragraph | 부대조건 상세 누락 |
| 40 | paragraph | 일본 관련 정보 누락 |
| 47 | paragraph | 구체적 수치 누락 (0.5%, 1년) |
| 50 | paragraph | - |
| 56 | paragraph | - |

---

## v1.1: PyMuPDF (무료)

### RAG 파이프라인
```
┌─────────────────────────────────────────────────────────────┐
│  Document Parser: PyMuPDF4LLM                               │
│  - 레이아웃 분석: 제한적                                     │
│  - 테이블 구조화: Markdown 변환 (단순)                       │
│  - OCR: 기본 텍스트 추출만                                   │
│  - 비용: 무료                                                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Image Captioning: GPT-4o                                   │
│  - 이미지 추출 제한적                                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Chunking: Hierarchical Chunker                             │
│  - Parent Chunk: 2000 tokens                                │
│  - Child Chunk: 500 tokens                                  │
│  - 총 청크: 11,288 (child) - 과다 분할                      │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Embedding: text-embedding-3-large (OpenAI)                 │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Vector Store: Qdrant                                       │
│  - Collection: advisor_osc_finance_pymupdf                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Retrieval: HierarchicalRetriever                           │
│  - top_k: 15                                                │
│  - rerank: Cohere Reranker (Trial - rate limited)           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Answer Generation: Gemini 3 Flash                          │
│  - Fallback: GPT-5-mini (27건 사용)                         │
└─────────────────────────────────────────────────────────────┘
```

### 테스트 결과
- **정확도**: 31.7% (19/60)
- **Fallback 사용**: 27건 (45%)
- **결과 파일**: `finance_v1.1_pymupdf_20260201_072718.json`

### 성능 저하 원인
1. **테이블 추출 실패**: 테이블 구조가 유지되지 않음 (10% 정확도)
2. **이미지 내 텍스트 미추출**: OCR 기능 부재 (30% 정확도)
3. **과다 청킹**: 11,288개 청크로 노이즈 증가

---

## 비용 분석 (301 페이지 기준)

| 파서 | 파싱 비용 | 임베딩 비용 | 총 비용 | 정확도 |
|------|----------|------------|--------|--------|
| Azure (Read) | $0.45 | ~$0.50 | **~$1.00** | 98.3% |
| Azure (Layout) | $3.01 | ~$0.50 | **~$3.50** | 98.3% |
| Gemini 3 Flash | ~$3.00 | ~$0.50 | **~$3.50** | 80.0% |
| PyMuPDF | $0.00 | ~$0.50 | **~$0.50** | 31.7% |

---

## 결론 및 권장사항

### 프로덕션 환경
- **추천**: Azure Document Intelligence (baseline_v1)
- **이유**: 최고 정확도 (98.3%), 안정적인 API

### 비용 절감이 중요한 경우
- **추천**: Gemini 3 Flash OCR (v1.2)
- **이유**: 80% 정확도로 실용적, Azure와 비슷한 비용

### 무료 대안 필요시
- **비추천**: PyMuPDF (v1.1)
- **이유**: 31.7% 정확도로 실용성 부족
- **대안**: Docling (IBM) 테스트 필요

---

## 파일 목록

```
results/
├── VERSION_COMPARISON.md          # 이 문서
├── finance_baseline_v1_azure_20260130.json
├── finance_v1.1_pymupdf_20260201_072718.json
└── finance_v1.2_gemini_20260201.json
```
